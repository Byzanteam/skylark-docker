$(function(){$("#calendar").calendar({ifSwitch:true,hoverDate:true,backToday:true})});(function($,window,document,undefined){var Calendar=function(elem,options){this.$calendar=elem;this.defaults={ifSwitch:true,hoverDate:false,backToday:false,startWeek:1};this.opts=$.extend({},this.defaults,options)};var clickdate,calenData=[],nowday,presentmonth;Calendar.prototype={showHoverInfo:function(obj){var _dateStr=$(obj).attr("data");var offset_t=$(obj).offset().top+(this.$calendar_today.height()-$(obj).height())/2;var offset_l=$(obj).offset().left+$(obj).width();var changeStr=addMark(_dateStr);var _week=changingStr(changeStr).getDay();nowday=_week;var _weekStr="";this.$calendar_today.css({left:offset_l+30,top:offset_t}).stop().animate({left:offset_l+16,top:offset_t});switch(_week){case 1:_weekStr="一";break;case 2:_weekStr="二";break;case 3:_weekStr="三";break;case 4:_weekStr="四";break;case 5:_weekStr="五";break;case 6:_weekStr="六";break;case 0:_weekStr="日";break}this.$calendarToday_date.text(changeStr);this.$calendarToday_week.text(_weekStr)},showCalendar:function(){var self=this;var year=dateObj.getDate().getFullYear();var month=dateObj.getDate().getMonth()+1;var dateStr=returnDateStr(dateObj.getDate());var firstDay=new Date(year,month-1,1);this.$calendarTitle_text.text(year+"-"+dateStr.substr(4,2));var nowweek;switch(new Date().getDay()){case 1:nowweek="一";break;case 2:nowweek="二";break;case 3:nowweek="三";break;case 4:nowweek="四";break;case 5:nowweek="五";break;case 6:nowweek="六";break;case 0:nowweek="日";break}this.$calendarDate_item.each(function(i){var allDay=new Date(year,month-1,i+1-firstDay.getDay());var allDay_str=returnDateStr(allDay);$(this).text(allDay.getDate()).attr("data",allDay_str);self.showHoverInfo($(this));if(returnDateStr(new Date())===allDay_str){var year_now=allDay.getFullYear();var month_now=(allDay.getMonth()+1)<10?"0"+(allDay.getMonth()+1):(allDay.getMonth()+1);var day_now=allDay.getDate()<10?"0"+allDay.getDate():allDay.getDate();var click_day_now=year_now+"-"+month_now+"-"+day_now;var user_id=$("#user_id").attr("user_id");var day_data={"day_time":click_day_now,"user_id":user_id};$.get("dayStatistics",day_data,function(res){if(res){if(res.is_morning_status!=0||res.is_afternoon_status!=0){$("#card_count").html(1)}if(res.is_morning_status!=0&&res.is_afternoon_status!=0){$("#card_count").html(2)}if(res.morning_time){$("#clock_static").show();$("#noclock").hide();$(".to_work_card").show();$("#to_work_time").html(res.morning_time);$("#to_work_address").html(res.morning_address);if(res.is_morning_status==1){$("#to_work_status").attr("class","normal");$("#out_work_status").html("正常")}else{$("#to_work_status").attr("class","lack");$("#to_work_status").html("迟到")}}if(res.afternoon_time){$("#clock_static").show();$("#noclock").hide();$(".out_work_card").show();$("#out_work_time").html(res.afternoon_time);$("#out_work_address").html(res.afternoon_address);if(res.is_afternoon_status==1){$("#out_work_status").attr("class","normal");$("#out_work_status").html("正常")}else{$("#out_work_status").attr("class","lack");$("#out_work_status").html("早退")}}}else{$("#clock_static").hide();$("#noclock").show();$("#card_count").html(0)}});$(this).attr("class","item item-curDay");$(this).parent().attr("style","display:block")}else{if(returnDateStr(firstDay).substr(0,6)===allDay_str.substr(0,6)){if(nowday==6||nowday==0){$(this).attr("class","item weekend");$(this).parent().attr("style","display:block")}else{$(this).attr("class","item item-curMonth");$(this).parent().attr("style","display:block")}}else{$(this).attr("class","item");if(i>=7){$(this).parent().attr("style","display:none")}}}});$(".checkdate").html(returnDateStr(new Date()).substr(0,4)+"-"+returnDateStr(new Date()).substr(4,2)+"-"+returnDateStr(new Date()).substring(6));$(".week").html(nowweek);if(self.selected_data){var selected_elem=self.$calendar_date.find("[data="+self.selected_data+"]");selected_elem.addClass("item-selected")}},renderDOM:function(){this.$calendar_title=$('<div class="calendar-title" style="display: none"></div>');this.$calendar_week=$('<ul class="calendar-week"></ul>');this.$calendar_date=$('<ul class="calendar-date"></ul>');this.$calendar_today=$('<div class="calendar-today"></div>');var _titleStr='<div class="arrow">'+'<span class="arrow-prev"><</span>'+'<a href="#" class="title"></a>'+'<span class="arrow-next">></span>'+"</div>";var _weekStr='<li class="item">日</li>'+'<li class="item">一</li>'+'<li class="item">二</li>'+'<li class="item">三</li>'+'<li class="item">四</li>'+'<li class="item">五</li>'+'<li class="item">六</li>';var _dateStr="";var _dayStr='<i class="triangle"></i>'+'<p class="date"></p>'+'<p class="week"></p>';for(var i=0;i<6;i++){_dateStr+='<div><li class="item">26</li><span></span></div>'+'<div><li class="item">26</li><span></span></div>'+'<div><li class="item">26</li><span></span></div>'+'<div><li class="item">26</li><span></span></div>'+'<div><li class="item">26</li><span></span></div>'+'<div><li class="item">26</li><span></span></div>'+'<div><li class="item">26</li><span></span></div>'
}this.$calendar_title.html(_titleStr);this.$calendar_week.html(_weekStr);this.$calendar_date.html(_dateStr);this.$calendar_today.html(_dayStr);this.$calendar.html("");this.$calendar.append(this.$calendar_title,this.$calendar_week,this.$calendar_date,this.$calendar_today);this.$calendar.show()},inital:function(){var self=this;this.renderDOM();this.$calendarTitle_text=this.$calendar_title.find(".title");this.$backToday=$("#backToday");this.$arrow_prev=this.$calendar_title.find(".arrow-prev");this.$arrow_next=this.$calendar_title.find(".arrow-next");this.$calendarDate_item=this.$calendar_date.find(".item");this.$calendarToday_date=this.$calendar_today.find(".date");this.$calendarToday_week=this.$calendar_today.find(".week");this.selected_data=0;this.showCalendar();if(this.opts.ifSwitch){this.$arrow_prev.bind("click",function(){var _date=dateObj.getDate();dateObj.setDate(new Date(_date.getFullYear(),_date.getMonth()-1,1));allthis.$calendarDate_item.each(function(i){$(this).next().html("")});rendertime();self.showCalendar()});this.$arrow_next.bind("click",function(){var _date=dateObj.getDate();dateObj.setDate(new Date(_date.getFullYear(),_date.getMonth()+1,1));allthis.$calendarDate_item.each(function(i){$(this).next().html("")});rendertime();self.showCalendar()})}if(this.opts.backToday){var cur_month=dateObj.getDate().getMonth()+1;this.$backToday.bind("click",function(){var item_month=$(".item-curMonth").eq(0).attr("data").substr(4,2);var if_lastDay=(item_month!=cur_month)?true:false;if(!self.$calendarDate_item.hasClass("item-curDay")||if_lastDay){dateObj.setDate(new Date());self.showCalendar()}})}this.$calendarDate_item.hover(function(){self.showHoverInfo($(this))},function(){self.$calendar_today.css({left:0,top:0}).hide()});var tips_flag=false;function closeTips(tips,delay,callback){if(tips_flag==false){tips_flag=true;setTimeout(function(){layui.layer.tips(tips,".layui-layer-setwin .layui-layer-close",{tips:3});if(callback){callback.call(this)}},(delay?delay:300))}}this.$calendarDate_item.mouseenter(function(){var onethis=$(this);var _dateStr=$(this).attr("data");var _date=changingStr(addMark(_dateStr));returnDateStr(_date);self.$calendarDate_item.each(function(i){});var $curClick=null;self.selected_data=$(this).attr("data");dateObj.setDate(new Date(_date.getFullYear(),_date.getMonth(),1));if(!$(this).hasClass("item-curMonth")){self.showCalendar()}$curClick=self.$calendar_date.find("[data="+_dateStr+"]");$curDay=self.$calendar_date.find(".item-curDay");if(!$curClick.hasClass("item-selected")){self.$calendarDate_item.removeClass("item-selected");$curClick.addClass("item-selected")}$(".checkdate").html(returnDateStr(_date).substr(0,4)+"-"+returnDateStr(_date).substr(4,2)+"-"+returnDateStr(_date).substring(6));var year=_date.getFullYear();var month=(_date.getMonth()+1)<10?"0"+(_date.getMonth()+1):(_date.getMonth()+1);var day=_date.getDate()<10?"0"+_date.getDate():_date.getDate();var click_day=year+"-"+month+"-"+day;var user_id=$("#user_id").attr("user_id");var day_data={"day_time":click_day,"user_id":user_id};$.get("dayStatistics",day_data,function(res){if(res){if(res.is_morning_status!=0||res.is_afternoon_status!=0){$("#card_count").html(1)}if(res.is_morning_status!=0&&res.is_afternoon_status!=0){$("#card_count").html(2)}if(res.morning_time){$("#clock_static").show();$("#noclock").hide();$(".to_work_card").show();$("#to_work_time").html(res.morning_time);$("#to_work_address").html(res.morning_address);if(res.is_morning_status==1){$("#to_work_status").attr("class","normal");$("#to_work_status").html("正常")}else{$("#to_work_status").attr("class","lack");$("#to_work_status").html("迟到")}}else{$("#clock_static").hide();$("#noclock").show();$(".to_work_card").hide()}if(res.afternoon_time){$("#clock_static").show();$("#noclock").hide();$(".out_work_card").show();$("#out_work_time").html(res.afternoon_time);$("#out_work_address").html(res.afternoon_address);if(res.is_afternoon_status==1){$("#out_work_status").attr("class","normal");$("#out_work_status").html("正常")}else{$("#out_work_status").attr("class","lack");$("#out_work_status").html("早退")}}else{$(".out_work_card").hide()}}else{$("#clock_static").hide();$("#noclock").show();$("#card_count").html("0")}})});var calenData={};var allthis=this;var date_show=new Date();var year_show=date_show.getFullYear();var month_show=(date_show.getMonth()+1)<10?"0"+(date_show.getMonth()+1):(date_show.getMonth()+1);var today_show=year_show+"-"+month_show;rendertime(today_show);function rendertime(time){var user_id=$("#user_id").attr("user_id");var transmission_data={"user_id":user_id,"time":time};$.get("showCard",transmission_data,function(data){calenData=data;if(calenData.length>0){for(var m=0;m<calenData.length;m++){allthis.$calendarDate_item.each(function(i){var datas=$(this).attr("data").substr(0,4)+"-"+$(this).attr("data").substr(4,2)+"-"+$(this).attr("data").substring(6);if(calenData[m].time_day==datas){if(calenData[m].is_morning_status!=1||calenData[m].is_afternoon_status!=1){$(this).next().addClass("circle_yellow").attr("id",calenData[m].id)
}else{$(this).next().addClass("circle").attr("id",calenData[m].id)}}})}}})}var checkdate;$(".calenbox").on("click",".clickmonth",function(){var index=$(this).index();$(".clickmonth img").attr("src","/static/images/checkno.png").eq(index).attr("src","/static/images/check.png");$(".box,.calenbox").fadeOut();var clickdate=$(this).data("date").split("-");var _date=dateObj.getDate();dateObj.setDate(new Date(clickdate[0],clickdate[1]-1,1));self.$calendarDate_item.each(function(i){$(this).next().removeClass("circle");$(this).next().removeClass("circle_yellow")});var day_show=clickdate[0]+"-"+clickdate[1];rendertime(day_show);self.showCalendar();$(".checkdate").html(clickdate[0]+"-"+clickdate[1]+"-"+"01");switch(new Date(clickdate[0]+"-"+clickdate[1]+"-"+"01").getDay()){case 1:checkdate="一";break;case 2:checkdate="二";break;case 3:checkdate="三";break;case 4:checkdate="四";break;case 5:checkdate="五";break;case 6:checkdate="六";break;case 0:checkdate="日";break}self.$calendarDate_item.each(function(i){var blockdate=$(this).attr("data").substr(0,4)+"-"+$(this).attr("data").substr(4,2)+"-"+$(this).attr("data").substring(6);if(clickdate[1]!=addMark(returnDateStr(new Date())).split("-")[1]){if((clickdate[0]+"-"+clickdate[1]+"-"+"01")===blockdate){var user_id=$("#user_id").attr("user_id");var day_data={"day_time":blockdate,"user_id":user_id};$.get("dayStatistics",day_data,function(res){if(res){if(res.is_morning_status!=0||res.is_afternoon_status!=0){$("#card_count").html(1)}if(res.is_morning_status!=0&&res.is_afternoon_status!=0){$("#card_count").html(2)}if(res.morning_time){$("#clock_static").show();$("#noclock").hide();$(".to_work_card").show();$("#to_work_time").html(res.morning_time);$("#to_work_address").html(res.morning_address);if(res.is_morning_status==1){$("#to_work_status").attr("class","normal");$("#to_work_status").html("正常")}else{$("#to_work_status").attr("class","lack");$("#to_work_status").html("迟到")}}else{$("#clock_static").hide();$("#noclock").show();$(".to_work_card").hide()}if(res.afternoon_time){$("#clock_static").show();$("#noclock").hide();$(".out_work_card").show();$("#out_work_time").html(res.afternoon_time);$("#out_work_address").html(res.afternoon_address);if(res.is_afternoon_status==1){$("#out_work_status").attr("class","normal");$("#out_work_status").html("正常")}else{$("#out_work_status").attr("class","lack");$("#out_work_status").html("早退")}}else{$(".out_work_card").hide()}}else{$("#clock_static").hide();$("#noclock").show();$("#card_count").html("0")}});$(this).attr("class","item item-curDay");$(this).parent().attr("style","display:block")}}});$(".week").html(checkdate)})},constructor:Calendar};$.fn.calendar=function(options){var calendar=new Calendar(this,options);return calendar.inital()};var dateObj=(function(){var _date=new Date();return{getDate:function(){return _date},setDate:function(date){_date=date}}})();function returnDateStr(date){var year=date.getFullYear();var month=date.getMonth()+1;var day=date.getDate();var week=date.getDay(),_weekStr;switch(week){case 1:_weekStr="一";break;case 2:_weekStr="二";break;case 3:_weekStr="三";break;case 4:_weekStr="四";break;case 5:_weekStr="五";break;case 6:_weekStr="六";break;case 0:_weekStr="日";break}$(".week").html(_weekStr);month=month<=9?("0"+month):(""+month);day=day<=9?("0"+day):(""+day);var clickdate=year+"-"+month+"-"+day;return year+month+day;return clickdate}function changingStr(fDate){var fullDate=fDate.split("-");return new Date(fullDate[0],fullDate[1]-1,fullDate[2])}function addMark(dateStr){return dateStr.substr(0,4)+"-"+dateStr.substr(4,2)+"-"+dateStr.substring(6)}function isLeapYear(year){return(year%4==0)&&(year%100!=0||year%400==0)}var myDate=new Date();var day;var month;var year;var dateStr="";var dateone="";for(var i=0;i<10;i++){day=(myDate.getDate()<10?"0":"")+myDate.getDate();var nowmonth=myDate.getMonth()+1;if((myDate.getMonth()+1-i)<1){month=((12+(myDate.getMonth()+1-i))<10?"0":"")+(12+(myDate.getMonth()+1-i));year=myDate.getFullYear()-1}else{month=((myDate.getMonth()+1-i)<10?"0":"")+(myDate.getMonth()+1-i);year=myDate.getFullYear()}if(i>0){dateStr+=","}if(month==nowmonth){dateone+='<div class="clickmonth" data-date="'+year+"-"+month+"-"+day+'">'+'<img src="/static/images/check.png">'+year+"年"+month+"月"+"</div>"}else{dateone+='<div class="clickmonth" data-date="'+year+"-"+month+"-"+day+'">'+'<img src="/static/images/checkno.png">'+year+"年"+month+"月"+"</div>"}dateStr+=year+"年"+month+"月"}$(".calenbox").html(dateone)})(jQuery,window,document);