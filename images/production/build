#!/usr/bin/env bash
set -e

# echo "Downloading skylark"
# wget -O skylark.tar.gz https://github.com/GreenNerd/skylark/archive/$SLP_VERSION.tar.gz
# echo "Download completed"

build_it() {
  cd ./skylark

  git checkout $1 --quiet
  echo "checkout to `git describe --tags`"
  echo "-----------------------"

  cd ..
  docker build -t dockerhub.qingcloud.com/skylark/production:$1 .
  docker push dockerhub.qingcloud.com/skylark/production:$1

  echo "----------------------------------"
  echo "Pushed $1 to docker dockerhub"
  echo "++++++++++++++++++++++++++++++++++"
}

if [[ $SLP_VERSION ]]; then
  echo "Building the production image"

  git submodule init
  git submodule update

  git fetch origin --tags

  build_it $SLP_VERSION
  build_it "$SLP_VERSION.gxzh"

  echo "-----------------------"
  cd ./skylark
  git checkout develop --quiet
  echo "checkout to `git describe --all`"
  cd ..

  echo "-----------------------"
  echo "Done!"
else
  echo "Please set SLP_VERSION!"
fi
